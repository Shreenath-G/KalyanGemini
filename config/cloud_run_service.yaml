apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: adaptive-ad-intelligence
  labels:
    cloud.googleapis.com/location: us-central1
    app: adaptive-ad-intelligence
    environment: production
  annotations:
    run.googleapis.com/description: "Adaptive Ad Intelligence Platform - Multi-agent advertising optimization system"
spec:
  template:
    metadata:
      annotations:
        # Auto-scaling configuration (Requirement 10.2)
        autoscaling.knative.dev/minScale: '1'
        autoscaling.knative.dev/maxScale: '100'
        autoscaling.knative.dev/target: '80'
        # Performance optimizations
        run.googleapis.com/cpu-throttling: 'false'
        run.googleapis.com/startup-cpu-boost: 'true'
        # Execution environment
        run.googleapis.com/execution-environment: gen2
    spec:
      containerConcurrency: 80
      timeoutSeconds: 300
      serviceAccountName: adaptive-ad-intelligence@PROJECT_ID.iam.gserviceaccount.com
      # VPC connector for private resources (Requirement 10.3)
      # Replace VPC_CONNECTOR_NAME with actual connector name
      # Example: projects/PROJECT_ID/locations/us-central1/connectors/adaptive-ad-vpc
      # vpcAccess:
      #   connector: projects/PROJECT_ID/locations/us-central1/connectors/VPC_CONNECTOR_NAME
      #   egress: private-ranges-only
      containers:
      - image: gcr.io/PROJECT_ID/adaptive-ad-intelligence:latest
        ports:
        - name: http1
          containerPort: 8080
        env:
        - name: ENVIRONMENT
          value: production
        - name: GOOGLE_CLOUD_PROJECT
          value: PROJECT_ID
        - name: GOOGLE_CLOUD_REGION
          value: us-central1
        - name: LOG_LEVEL
          value: INFO
        - name: VERTEX_AI_LOCATION
          value: us-central1
        - name: VERTEX_AI_MODEL
          value: gemini-pro
        - name: ADK_CONFIG_PATH
          value: config/adk_config.yaml
        - name: RATE_LIMIT_PER_MINUTE
          value: '100'
        - name: AGENT_TIMEOUT_SECONDS
          value: '30'
        - name: PERFORMANCE_CHECK_INTERVAL_MINUTES
          value: '15'
        # Secrets from Secret Manager (Requirement 13.2, 13.3)
        - name: VERTEX_AI_API_KEY
          valueFrom:
            secretKeyRef:
              name: vertex-ai-api-key
              key: latest
        - name: FIRESTORE_CREDENTIALS
          valueFrom:
            secretKeyRef:
              name: firestore-credentials
              key: latest
        - name: API_KEYS
          valueFrom:
            secretKeyRef:
              name: api-keys
              key: latest
        - name: AD_PLATFORM_GOOGLE_KEY
          valueFrom:
            secretKeyRef:
              name: ad-platform-google-key
              key: latest
        - name: AD_PLATFORM_META_KEY
          valueFrom:
            secretKeyRef:
              name: ad-platform-meta-key
              key: latest
        resources:
          limits:
            cpu: '2'
            memory: 4Gi
        livenessProbe:
          httpGet:
            path: /api/health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /api/health
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
  traffic:
  - percent: 100
    latestRevision: true
---
# Ingress configuration for TLS enforcement
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: adaptive-ad-intelligence-cert
spec:
  domains:
    - adaptive-ad-intelligence.example.com  # Replace with actual domain
---
# Security policy for TLS 1.3 enforcement
apiVersion: compute.cnrm.cloud.google.com/v1beta1
kind: ComputeSSLPolicy
metadata:
  name: adaptive-ad-intelligence-ssl-policy
spec:
  minTlsVersion: TLS_1_3
  profile: MODERN
  description: "Enforce TLS 1.3 for all API communications (Requirement 13.2)"
